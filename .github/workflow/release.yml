name: Release

on:
  push:
    tags:
      - 'v*' # è§¦å‘æ‰€æœ‰ä»¥vå¼€å¤´çš„tag

jobs:
  build:
    name: Create Release
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²è®°å½•ä»¥ä¾¿ç”Ÿæˆæ›´æ–°æ—¥å¿—

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '7.0.x'

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - name: Install conventional-changelog
        run: |
          npm install -g conventional-changelog-cli
          npm install -g conventional-changelog-conventionalcommits

      - name: Generate changelog
        id: changelog
        shell: bash
        run: |
          # è·å–æœ€è¿‘çš„ä¸¤ä¸ªtag
          CURRENT_TAG=${GITHUB_REF#refs/tags/}
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 ${CURRENT_TAG}^ 2>/dev/null || echo "")
          
          # é…ç½®conventional-changelogä»¥æ”¯æŒä¸­æ–‡è¾“å‡º
          CONFIG='{"types":[{"type":"feat","section":"âœ¨ æ–°åŠŸèƒ½"},{"type":"fix","section":"ğŸ› ä¿®å¤"},{"type":"perf","section":"âš¡ æ€§èƒ½ä¼˜åŒ–"},{"type":"refactor","section":"â™»ï¸ é‡æ„"},{"type":"style","hidden":true},{"type":"docs","hidden":true},{"type":"test","hidden":true},{"type":"chore","hidden":true}]}'
          
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "## ğŸ‰ é¦–æ¬¡å‘å¸ƒ" > CHANGELOG.md
            conventional-changelog -p conventionalcommits -c <(echo "$CONFIG") >> CHANGELOG.md
          else
            echo "## â­ æ›´æ–°å†…å®¹ ($PREVIOUS_TAG -> $CURRENT_TAG)" > CHANGELOG.md
            conventional-changelog -p conventionalcommits -c <(echo "$CONFIG") -r 2 >> CHANGELOG.md
          fi
          
          # å¤„ç†æ›´æ–°æ—¥å¿—æ ¼å¼
          sed -i 's/### /#### /g' CHANGELOG.md  # é™ä½æ ‡é¢˜çº§åˆ«
          sed -i 's/BREAKING CHANGE/ğŸ’¥ é‡å¤§å˜æ›´/g' CHANGELOG.md
          
          # ä¿å­˜æ›´æ–°æ—¥å¿—å†…å®¹
          CHANGELOG_CONTENT=$(cat CHANGELOG.md)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build project
        run: |
          dotnet restore
          dotnet build -c Release

      - name: Create artifacts directory
        run: mkdir artifacts

      - name: Publish beatmapDownloader
        run: |
          dotnet publish beatmapDownloader/beatmapDownloader.csproj \
            -c Release \
            -r win-x64 \
            --self-contained true \
            -p:PublishSingleFile=true \
            -o artifacts/beatmapDownloader-win-x64

      - name: Compress artifacts
        shell: bash
        run: |
          cd artifacts
          zip -r beatmapDownloader-win-x64.zip beatmapDownloader-win-x64/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/beatmapDownloader-win-x64.zip
          body: |
            ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
